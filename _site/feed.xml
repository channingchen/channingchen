<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>papa@melonfamily</title>
    <description>Here is papa's blog in melonfamily.
</description>
    <link>http://papa.melonfamily.com/</link>
    <atom:link href="http://papa.melonfamily.com/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Mon, 30 Oct 2017 09:24:42 +0800</pubDate>
    <lastBuildDate>Mon, 30 Oct 2017 09:24:42 +0800</lastBuildDate>
    <generator>Jekyll v3.6.2</generator>
    
      <item>
        <title>速读拓展：2017.10</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/listenbook.jpeg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;日本的八个审美意识&quot;&gt;日本的八个审美意识&lt;/h2&gt;
&lt;h2 id=&quot;如何看懂印象派&quot;&gt;如何看懂印象派&lt;/h2&gt;
&lt;h2 id=&quot;现代艺术150年&quot;&gt;现代艺术150年&lt;/h2&gt;
&lt;h2 id=&quot;宇宙的结构&quot;&gt;宇宙的结构&lt;/h2&gt;
&lt;h2 id=&quot;娱乐至死&quot;&gt;娱乐至死&lt;/h2&gt;
&lt;h2 id=&quot;日本漫画60年&quot;&gt;日本漫画60年&lt;/h2&gt;
&lt;h2 id=&quot;20世纪最伟大的心理学实验&quot;&gt;20世纪最伟大的心理学实验&lt;/h2&gt;
&lt;h2 id=&quot;深度工作&quot;&gt;深度工作&lt;/h2&gt;
&lt;h2 id=&quot;智识分子&quot;&gt;智识分子&lt;/h2&gt;
&lt;h2 id=&quot;高效的秘密&quot;&gt;高效的秘密&lt;/h2&gt;
&lt;h2 id=&quot;惊人的假说&quot;&gt;惊人的假说&lt;/h2&gt;
&lt;h2 id=&quot;潜意识&quot;&gt;潜意识&lt;/h2&gt;
&lt;h2 id=&quot;由内而外的教养&quot;&gt;由内而外的教养&lt;/h2&gt;
&lt;h2 id=&quot;围城&quot;&gt;围城&lt;/h2&gt;
&lt;h2 id=&quot;植物知道生命的答案&quot;&gt;植物知道生命的答案&lt;/h2&gt;
&lt;h2 id=&quot;魔鬼经济学&quot;&gt;魔鬼经济学&lt;/h2&gt;
&lt;h2 id=&quot;哈佛中国史&quot;&gt;哈佛中国史&lt;/h2&gt;
&lt;p&gt;外国人写的中国历史：中国史犹如一件房子，中国人在房子里面，能看清所有细节，但外国人在房子外面，能看清房屋全貌，这就是外国人写中国史的意义。&lt;/p&gt;
&lt;h3 id=&quot;1早期中华帝国秦与汉-秦汉之于中国就像希腊罗马之于西方是古典时代这个时代形成的特点或多或少影响着后来整个中国历史&quot;&gt;1.《早期中华帝国：秦与汉》 ：秦汉之于中国就像希腊罗马之于西方，是古典时代，这个时代形成的特点或多或少影响着后来整个中国历史。&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;/assets/img/fastreading/history-of-imperial-china-1.jpeg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;秦统一中国，但在之后相当长的时间里，国民身份认同（中国人）还未形成；&lt;/li&gt;
  &lt;li&gt;秦统一中国，设立了新职位————“皇帝”，将权力抓至中央；&lt;/li&gt;
  &lt;li&gt;从汉开始，儒学获得统治地位，并形成体系，最终发展成几乎所有领域的社会行为规范；&lt;/li&gt;
  &lt;li&gt;普遍兵役制消失，军人往职业化发展；&lt;/li&gt;
  &lt;li&gt;地方大家族势力兴起，最初被政府打压，一点点变成合作，最终脱离中央掌控演变为军阀割据，将东汉灭亡。
    &lt;h4 id=&quot;印象&quot;&gt;印象：&lt;/h4&gt;
    &lt;blockquote&gt;
      &lt;ol&gt;
        &lt;li&gt;中国人的世界存在一系列自相矛盾的平衡关系&lt;/li&gt;
        &lt;li&gt;战国时期，地方主义和民族主义倾向随着知识分子的流动而缓和，他们奔波于各个诸侯国求学或寻求保护，因此形成了更开阔的“天下观”&lt;/li&gt;
      &lt;/ol&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;基业长青&quot;&gt;基业长青&lt;/h2&gt;
</description>
        <pubDate>Fri, 27 Oct 2017 09:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E6%AF%8F%E5%A4%A9%E5%90%AC%E6%9C%AC%E4%B9%A6/2017/10/27/fast-reading.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E6%AF%8F%E5%A4%A9%E5%90%AC%E6%9C%AC%E4%B9%A6/2017/10/27/fast-reading.html</guid>
        
        <category>vision</category>
        
        
        <category>每天听本书</category>
        
      </item>
    
      <item>
        <title>《奇特的一生》</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/awesomelife.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;书名&lt;/th&gt;
      &lt;th&gt;作者&lt;/th&gt;
      &lt;th&gt;字数&lt;/th&gt;
      &lt;th&gt;开始时间&lt;/th&gt;
      &lt;th&gt;完成时间&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;奇特的一声&lt;/td&gt;
      &lt;td&gt;柳比歇夫&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;2017-01-01&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;核心脑图&quot;&gt;核心&amp;amp;脑图&lt;/h2&gt;
&lt;p&gt;alife&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;h2 id=&quot;摘录&quot;&gt;摘录&lt;/h2&gt;
</description>
        <pubDate>Sat, 21 Oct 2017 10:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/10/21/a-wonderful-life.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/10/21/a-wonderful-life.html</guid>
        
        <category>vision</category>
        
        
        <category>读书笔记</category>
        
      </item>
    
      <item>
        <title>《未来简史》</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/homodeus.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;书名&lt;/th&gt;
      &lt;th&gt;作者&lt;/th&gt;
      &lt;th&gt;字数&lt;/th&gt;
      &lt;th&gt;开始时间&lt;/th&gt;
      &lt;th&gt;完成时间&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;未来简史&lt;/td&gt;
      &lt;td&gt;尤瓦尔·赫拉利&lt;/td&gt;
      &lt;td&gt;307k&lt;/td&gt;
      &lt;td&gt;2017-10-20&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;核心脑图&quot;&gt;核心&amp;amp;脑图&lt;/h2&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;h2 id=&quot;摘录&quot;&gt;摘录&lt;/h2&gt;
</description>
        <pubDate>Sat, 21 Oct 2017 10:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/10/21/a-brief-history-of-tomorrow.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/10/21/a-brief-history-of-tomorrow.html</guid>
        
        <category>vision</category>
        
        
        <category>读书笔记</category>
        
      </item>
    
      <item>
        <title>离开杭州，来到上海</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/hz2sh.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;终于来到了上海，和媳妇团聚了。离开杭州的时候，写下了&lt;a href=&quot;/杂记/2017/09/27/init.html&quot;&gt;《围城》&lt;/a&gt;，记述了那个时候的不安和纠结。在离开杭州最后的日子，办完了离职手续，恰逢团队在三台山团建，也就一块跟着去了。杨公堤西面有一处很幽静的地方，湖畔大学就坐落在那里，大家沿着龙井山里幽静的小路一边走一边欣赏，走累了就在农家乐喝茶，嗑点瓜子，看看书，好不悠闲。&lt;/p&gt;

&lt;p&gt;晚上开饭前，各位小老板先汇报了各自团队的KPI，之后大老板再做总结。老板总结之前，告诉了大家我要离开的消息，同时讨论了和我之前谈话中的一个问题：“公司的成功，和我个人的成功，两者有何关系”。老板觉得，公司如果能够成功，一定是公司在某些方面作对了事情，这种作对是很难的，那么作为公司里的个人，肯定会被这个公司裹挟着往前，被裹挟着往前的话，即使你不知道该做什么该怎么做，也很可能在做对的事情，那么到最后可能你就莫名其妙的成功了。同时还推荐了我们所有人一本书，叫做《基业长青》，他主要讲了里面的三个点，送给即将离开的我，以及在场的所有人：一个胆大妄为的目标、告诉自己永远不够好以及不忘初心。他希望我能带着这些离开，带着这些精神和做事的方法离开，那么在任何一个地方，无论环境上是好还是差，都能让自己得到发展。实话来说，第一份工作找到这种能对你人生有所启发的老板，确实是一件很幸运的事情，我们的几次谈话，谈话里涉及到的思考，都对我很有帮助。离开了杭州奔赴上海，离开了毕业后的第一家公司第一份工作，最后的团建，也算是一个圆满的句号了。&lt;/p&gt;

&lt;p&gt;从我这段时间的思考里，也是这段时间不断的思维上的拷问中，我慢慢的淡定了下来，选择没有所谓的对错，真正重要的是选择之后的道路，你是否有拼尽努力去完成。既然我已经留在了上海和媳妇团聚，生活上非常大的不确定因素就没有了，我应该像老板所说，带着那些精神去push我自己成长，从而证明我自己。&lt;/p&gt;
</description>
        <pubDate>Sat, 21 Oct 2017 08:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E6%9D%82%E8%AE%B0/2017/10/21/from-hangzhou-to-shanghai.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E6%9D%82%E8%AE%B0/2017/10/21/from-hangzhou-to-shanghai.html</guid>
        
        <category>misc</category>
        
        
        <category>杂记</category>
        
      </item>
    
      <item>
        <title>《活出生命的意义》</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/manssearchformeaning.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;书名&lt;/th&gt;
      &lt;th&gt;作者&lt;/th&gt;
      &lt;th&gt;字数&lt;/th&gt;
      &lt;th&gt;开始时间&lt;/th&gt;
      &lt;th&gt;完成时间&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;活出生命的意义&lt;/td&gt;
      &lt;td&gt;维克多·E·弗兰克尔&lt;/td&gt;
      &lt;td&gt;2h&lt;/td&gt;
      &lt;td&gt;2017-09-07&lt;/td&gt;
      &lt;td&gt;2017-09-10&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;核心脑图&quot;&gt;核心&amp;amp;脑图&lt;/h2&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;h2 id=&quot;摘录&quot;&gt;摘录&lt;/h2&gt;
</description>
        <pubDate>Wed, 27 Sep 2017 11:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/09/27/mans-search-for-meaning.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/09/27/mans-search-for-meaning.html</guid>
        
        <category>vision</category>
        
        
        <category>读书笔记</category>
        
      </item>
    
      <item>
        <title>《穷查理宝典》</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/poorcharlie.jpeg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;书名&lt;/th&gt;
      &lt;th&gt;作者&lt;/th&gt;
      &lt;th&gt;字数&lt;/th&gt;
      &lt;th&gt;开始时间&lt;/th&gt;
      &lt;th&gt;完成时间&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;穷查理宝典&lt;/td&gt;
      &lt;td&gt;查理·芒格&lt;/td&gt;
      &lt;td&gt;12h&lt;/td&gt;
      &lt;td&gt;2017-08-09&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;核心脑图&quot;&gt;核心&amp;amp;脑图&lt;/h2&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;h2 id=&quot;摘录&quot;&gt;摘录&lt;/h2&gt;
</description>
        <pubDate>Wed, 27 Sep 2017 10:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/09/27/poor-charlies-almanack.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/09/27/poor-charlies-almanack.html</guid>
        
        <category>vision</category>
        
        
        <category>读书笔记</category>
        
      </item>
    
      <item>
        <title>花一份时间，做几份事情——论聪明的事半功倍</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/domorewithless.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;吴军的2016年总结&quot;&gt;吴军的2016年总结&lt;/h2&gt;
&lt;p&gt;在得到上订阅了吴军的专栏，每天听一些他对各种事情的看法、以及对人生的一些见识，基本上每一篇文章都能对我或多或少有一些启发。前天洗澡的时候，恰好听到他对于自己的2016总结，虽然他仅仅是一条一条列出来，但是我却从字里行间得到了他没说的一个启发。他2016大概的成绩是这些：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;作为投资人，占据了他整体30%～40%的时间（日常主业）；&lt;/li&gt;
  &lt;li&gt;在商学院和培训班讲课100个学时，&lt;strong&gt;&lt;em&gt;同时&lt;/em&gt;&lt;/strong&gt;讲课内容整理成了两本书《硅谷之谜》&amp;amp;《智能时代》；&lt;/li&gt;
  &lt;li&gt;写成了《文明之光》第四册；&lt;/li&gt;
  &lt;li&gt;在得到APP上尝试做了一年专栏，&lt;strong&gt;&lt;em&gt;同时&lt;/em&gt;&lt;/strong&gt;将专栏内容整理成了《见识》这本书；&lt;/li&gt;
  &lt;li&gt;听了两门公开课，一门生物学，一门法律，&lt;strong&gt;&lt;em&gt;除了&lt;/em&gt;&lt;/strong&gt;兴趣&lt;strong&gt;&lt;em&gt;还有&lt;/em&gt;&lt;/strong&gt;就是为了写书；&lt;/li&gt;
  &lt;li&gt;读了大约20本书，其中一小半&lt;strong&gt;&lt;em&gt;同时&lt;/em&gt;&lt;/strong&gt;是为了给出版社写序；&lt;/li&gt;
  &lt;li&gt;摄影水平得到提高，通过看书学习和练习，同时参加的摄影课程分享到了得到APP上；&lt;/li&gt;
  &lt;li&gt;公益事业，还有帮助朋友开公司；&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;他在列举2016的重点成绩时，最吸引我的却是上述被我加粗的地方————这才是真正的事半功倍。他可以将自己做的事情，在多个方面得到成果，也或许，他是先观察了可能要做的所有事情，然后仅仅挑选那些最有价值的（单个领域价值*领域数目）去做。我觉得这点非常棒，&lt;strong&gt;花一份时间，得到多份的收益&lt;/strong&gt;，这才是使用时间这种最宝贵的资源的正道啊。&lt;/p&gt;
&lt;h2 id=&quot;生活中的举例&quot;&gt;生活中的举例&lt;/h2&gt;
&lt;p&gt;要问我自己的生活中，有没有这样的例子，其实也是有的。比如我最近的跨学科学习，本质上也是期望有一种事半功倍的效果。因为多学科会让你对这个世界运行的基础规律有更深入的了解，对基础的、通用的东西了解更多了之后，就能服务于其上搭建的个异性的系统，这就是一种事半功倍的学习。短期来看，越是基础的东西，越不太可能带来显而易见的收益，但是长期来看，这是一份非常划算的投资。&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;
&lt;p&gt;总结下来，在订立目标做事情的时候，要着重考虑可积累、可通用的、能够带来多份效益的事情。寻找、判定这些事情花费的时间是值得的，因为只有这样，才能更好的利用你宝贵的时间。反观，如果你做的事情所投入的“单份时间“仅能带来“单份价值”，那么就会很不划算。&lt;/p&gt;
</description>
        <pubDate>Wed, 27 Sep 2017 09:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E6%9D%82%E8%AE%B0/2017/09/27/do-more-with-less.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E6%9D%82%E8%AE%B0/2017/09/27/do-more-with-less.html</guid>
        
        
        <category>杂记</category>
        
      </item>
    
      <item>
        <title>log4j:RollingFileAppender Improvment</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/log4j.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;发现问题&quot;&gt;发现问题&lt;/h2&gt;
&lt;p&gt;A系统的rpc服务（使用HSF框架）调用方B反馈，最近总是会调用服务超时，发生的时间没有规律，每天大概几百次左右，所以找到A系统的负责人，也就是我，查找问题。&lt;/p&gt;

&lt;h2 id=&quot;查找原因&quot;&gt;查找原因&lt;/h2&gt;
&lt;p&gt;了解有超时现象后，先让调用方B提供具体的rpc日志，想看一看是哪些接口、在什么时间超时。调用方B提供了两天左右的准确的超时日志，研究后发现，大约集中在两个接口上，这两个接口都是调用非常频繁的接口，且都有缓存，性能上应该很好。&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;通过公司中的监控平台，仔细对照了超时发生时的时间段，发现从tomcat中采集出的spring bean运行时间日志，没有什么异常，那些业务方B反馈的接口耗时最多的才100ms，平均20ms不到；&lt;/li&gt;
  &lt;li&gt;又看了下那些时间段的JVM的各项指标，没有FullGC，内存情况良好，磁盘读写良好，线程数倒是有有些突刺，但时间上吻合程度不高，所以没怎么在意；&lt;/li&gt;
  &lt;li&gt;好在调用方的日志里面有准确的时间和查询参数，结合这两项指标，也能找到对应机器上的rpc日志，发现确实有超时，超时的记录也很明确（HSF日志提供了一些调用链的分析，能够看清远程调用耗时和本地耗时）；&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;经过上面一轮搜寻一无所获，仅仅是明确了那些时间点上，接口确实变慢了，变慢的原因也是发生在应用里，却没法确定到底是什么原因。在代码层面寻找可能的耗时操作也一无所获，所以注意力仍旧集中到了分析调用方B的超时日志上。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;2017-09-29 03:29:48,281 ERROR helper.XXXServiceHelper:85 queryInfo - XXXServiceHelper queryInfo error;uid=1434302683660970
2017-09-29 03:29:48,438 ERROR helper.XXXServiceHelper:85 queryInfo - XXXServiceHelper queryInfo error;uid=1992173055745769
2017-09-29 05:42:33,652 ERROR helper.XXXServiceHelper:85 queryInfo - XXXServiceHelper queryInfo error;uid=1522284039696604
2017-09-29 05:42:34,174 ERROR helper.XXXServiceHelper:85 queryInfo - XXXServiceHelper queryInfo error;uid=1522284039696604
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;业务方B的日志大概没隔1小时会发生几例超时，有时候不到1小时。找了其中一条超时日志（例如2017-09-29 03:29:48这条），把A系统的rpc日志、HSF日志、APP日志等等看了一圈，实在看不出什么特别的。正一筹莫展的时候，突然发现了一段熟悉的时间：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[papa@melonfamily.host /data/www/logs/tomcat7/xxxApp]$ll
total 16431224
-rw-rw-r-- 1 tomcat tomcat 1003283623 Sep 29 03:29 rpcTrace.log.2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;不会这么巧吧？日志滚动的时间和发生超时的时间基本重合，查看下这个时候的最后一条rpc日志吧？&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[papa@melonfamily.host /data/www/logs/tomcat7/xxxApp]$tail -n 1 rpcTrace.log.2
2017-09-29 03:29:46,021 [] INFO  rpcTraceLogger - {&quot;xxxxInfo&quot;:&quot;xxxValue&quot;,&quot;method&quot;:&quot;queryInfo&quot;,&quot;service&quot;:&quot;XXXService&quot;,&quot;startTime&quot;:1506626986021,&quot;success&quot;:true,&quot;traceInfo&quot;:{&quot;requestId&quot;:&quot;129.2_1506626986021_6&quot;,&quot;stepIndex&quot;:&quot;0&quot;,&quot;traceType&quot;:&quot;hsf_provider&quot;},&quot;usedTime&quot;:2160}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这条日志的开始时间2017-09-29 03:29:46加上2s后，恰好等于对方机器的超时记录时间。赶紧看了看当天其他的机器的日志滚动时间以及超时时刻，都吻合!看来日志滚动八成是造成服务超时的原因了。&lt;/p&gt;
&lt;h2 id=&quot;追寻根源&quot;&gt;追寻根源&lt;/h2&gt;
&lt;p&gt;日志滚动为何会导致那一时刻的服务超时呢？直观来想，应该是记录rpc日志时恰好遇到日志滚动，导致那个线程阻塞了，这也能解释为何JVM线程监控上在某些超时时间点上有毛刺，虽然并不是完全吻合。同时，因为rpc日志使用的是切面的方式环绕在service的方法上下的，所以tomcat中关于bean执行时间的监控并不能覆盖到rpc日志的阻塞时间，这也解释了为何观察出问题时段的bean执行时间不曾有超时现象。
A系统使用了log4j的RollingFileAppender来做rpc的日志记录，MaxBackupIndex设置为10，MaxFileSize设置为1G。linux上删除1G文件时确实会有些许的耗时，但日志记录是怎样和日志滚动互相阻塞同步的呢？下面是使用log4j记录日志时的时序图：
&lt;img src=&quot;/assets/img/rollingFileAppender-timeline.png&quot; alt=&quot;&quot; /&gt;
doAppend方法带有sychronized关键字，而rollOver方法被包含在doAppend中，当日志数目达到设定值且写入超过限定大小时，会执行文件删除。所以尽管rollOver方法本身没做同步，但其实跟记录日志是在一块竞争执行的，最终导致删除大文件时会卡住日志记录。&lt;/p&gt;
&lt;h2 id=&quot;寻找方案&quot;&gt;寻找方案&lt;/h2&gt;
&lt;p&gt;如何优化日志滚动呢？下面是我采取的一个方案：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;public class MyRollingFileAppder extends RollingFileAppender {
    class DeleteFileTask implements Runnable {
        File file;

        DeleteFileTask(File file) {
            this.file = file;
        }

        public void run() {
            if (null == file) {
                return;
            }
            if (file.exists()) {
                LogLog.debug(System.currentTimeMillis() + &quot; start delete &quot; + file.getAbsolutePath());
                file.delete();
                LogLog.debug(System.currentTimeMillis() + &quot; finish delete &quot; + file.getAbsolutePath());
            }
        }
    }

    @Override
    public void rollOver() {
        File target;
        File file;

        LogLog.debug(&quot;rolling over count=&quot; + ((CountingQuietWriter) qw).getCount());
        LogLog.debug(&quot;maxBackupIndex=&quot; + maxBackupIndex);

        // If maxBackups &amp;lt;= 0, then there is no file renaming to be done.
        if (maxBackupIndex &amp;gt; 0) {
            // Map {(maxBackupIndex), ..., 2, 1} to {maxBackupIndex+1, ..., 3, 2}
            for (int i = maxBackupIndex; i &amp;gt;= 1; i--) {
                file = new File(fileName + &quot;.&quot; + i);
                if (file.exists()) {
                    target = new File(fileName + '.' + (i + 1));
                    if (target.exists()) {
                        //if target exists, means DeleteFileTask is too slow. we have no choice but delete synchronously.
                        LogLog.debug(
                                System.currentTimeMillis() + &quot;, rollOver: delete log synchronously happened, file=&quot; + target
                                        .getAbsolutePath());
                        target.delete();
                    }
                    LogLog.debug(&quot;Renaming file &quot; + file + &quot; to &quot; + target);
                    file.renameTo(target);
                }
            }

            // Rename fileName to fileName.1
            target = new File(fileName + &quot;.&quot; + 1);

            this.closeFile(); // keep windows happy.

            file = new File(fileName);
            LogLog.debug(&quot;Renaming file &quot; + file + &quot; to &quot; + target);
            file.renameTo(target);

            // Delete the overflow(maxBackupIndex+1) file asynchronously, to keep Windows happy.
            file = new File(fileName + '.' + (maxBackupIndex + 1));
            if (file.exists()) {
                DeleteFileTask task = new DeleteFileTask(file);
                task.run();
            }
        }

        try {
            // This will also close the file. This is OK since multiple
            // close operations are safe.
            this.setFile(fileName, false, bufferedIO, bufferSize);
        } catch (IOException e) {
            LogLog.error(&quot;setFile(&quot; + fileName + &quot;, false) call failed.&quot;, e);
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;MyRollingFileAppder集成了RollingFileAppder，并覆盖了rollOver方法，RollingFileAppder中的rollOver方法做了以下几件事情：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;如果xxx.log.MaxBackupIndex存在，证明日志数目已满，直接删除这个文件；&lt;/li&gt;
  &lt;li&gt;对xxx.log.MaxBackupIndex-1~xxx.log.1，如果存在就重命名，依次向后滚动一下，变成xxx.log.MaxBackupIndex~xxx.log.2;&lt;/li&gt;
  &lt;li&gt;将目前满的文件从xxx.log重命名为xxx.log.1，并创建新的xxx.log;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;我们已经知道耗时发生在第一步，所以优化的代码中，改进了这个流程：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;对xxx.log.MaxBackupIndex~xxx.log.1，如果存在，测试其增加1后的文件是否存在，如果不存在则重命名，依次向后滚动一下，变成xxx.log.MaxBackupIndex+1~xxx.log.2；如果其增加1后的文件存在，则&lt;strong&gt;同步&lt;/strong&gt;删除“增加1后的文件”;&lt;/li&gt;
  &lt;li&gt;将目前满的文件从xxx.log重命名为xxx.log.1，并创建新的xxx.log;&lt;/li&gt;
  &lt;li&gt;如果xxx.log.MaxBackupIndex+1存在，证明日志数目已满，&lt;strong&gt;异步&lt;/strong&gt;删除这个文件；&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这里把删除动作后置，并异步，通过这种方法剔除删除对于记录日志的影响；但也存在可能，当删除真的很慢，异步删除未完成时，新日志已经被打满触发了下一次滚动，此时已然采用保守的同步删除法。其实这种情况在实际应用中基本不可能发生：删除过慢是因为文件较大，文件分片较大那么就不会那么容易被填满，简单来说，就是让有意义的日志填满一个1G的文件耗时，肯定要大于把这个1G文件直接删除。&lt;/p&gt;

&lt;h2 id=&quot;实验结果&quot;&gt;实验结果&lt;/h2&gt;
&lt;p&gt;本地测试时流程能符合预期。目前已经部署A系统的预发环境，尚未部署到生产，部署过后来更新结果。&lt;/p&gt;
</description>
        <pubDate>Wed, 27 Sep 2017 09:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/programming/2017/09/27/log4j-improve-RollingFileAppender.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/programming/2017/09/27/log4j-improve-RollingFileAppender.html</guid>
        
        <category>Java,log4j</category>
        
        
        <category>Programming</category>
        
      </item>
    
      <item>
        <title>《人类简史》</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/sapiens.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;书名&lt;/th&gt;
      &lt;th&gt;作者&lt;/th&gt;
      &lt;th&gt;字数&lt;/th&gt;
      &lt;th&gt;开始时间&lt;/th&gt;
      &lt;th&gt;完成时间&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;人类简史：从动物到上帝&lt;/td&gt;
      &lt;td&gt;尤瓦尔·赫拉利&lt;/td&gt;
      &lt;td&gt;307k&lt;/td&gt;
      &lt;td&gt;2017-09-09&lt;/td&gt;
      &lt;td&gt;2017-09-30&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;核心脑图&quot;&gt;核心&amp;amp;脑图&lt;/h2&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;h2 id=&quot;摘录&quot;&gt;摘录&lt;/h2&gt;
</description>
        <pubDate>Wed, 27 Sep 2017 09:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/09/27/sapiens.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/2017/09/27/sapiens.html</guid>
        
        <category>vision</category>
        
        
        <category>读书笔记</category>
        
      </item>
    
      <item>
        <title>跨学科(cross-disciplinary)阅读指南</title>
        <description>&lt;p&gt;&lt;img src=&quot;/assets/img/cross-discipinary.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;why-cross-disciplinary&quot;&gt;Why cross-disciplinary?&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;To the man with a hammer, the world looks like a nail.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;详情&quot;&gt;详情&lt;/h2&gt;
&lt;p&gt;学科和书目会持续更新，读完的内容要求有系统的笔记和总结，并标记已读。持续时间约为2017-2020。&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;分类I&lt;/th&gt;
      &lt;th&gt;分类II&lt;/th&gt;
      &lt;th&gt;书目&lt;/th&gt;
      &lt;th&gt;开始时间&lt;/th&gt;
      &lt;th&gt;结束时间&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;基础科学&lt;/td&gt;
      &lt;td&gt;数学&lt;/td&gt;
      &lt;td&gt;什么是数学&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;物理&lt;/td&gt;
      &lt;td&gt;物理世界奇遇记&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;化学&lt;/td&gt;
      &lt;td&gt;化学史传&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;统计学&lt;/td&gt;
      &lt;td&gt;女士品茶&lt;/td&gt;
      &lt;td&gt;2017-10-15&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;人文社科&lt;/td&gt;
      &lt;td&gt;生物&lt;/td&gt;
      &lt;td&gt;普通生物学&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;经济&lt;/td&gt;
      &lt;td&gt;经济学原理&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;心理学&lt;/td&gt;
      &lt;td&gt;心理学与生活&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;地理学&lt;/td&gt;
      &lt;td&gt;地理学与生活&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;广告学&lt;/td&gt;
      &lt;td&gt;一个广告人的自白&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;语言学&lt;/td&gt;
      &lt;td&gt;语言本能&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;法学&lt;/td&gt;
      &lt;td&gt;法律之门&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;医学&lt;/td&gt;
      &lt;td&gt;病者生存&lt;/td&gt;
      &lt;td&gt;2017-09-01&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;建筑学&lt;/td&gt;
      &lt;td&gt;像建筑师那样思考&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;航空&lt;/td&gt;
      &lt;td&gt;我怎样设计飞机&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;机械&lt;/td&gt;
      &lt;td&gt;最大的小发明&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;音乐&lt;/td&gt;
      &lt;td&gt;古典作曲家排行榜&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
</description>
        <pubDate>Wed, 27 Sep 2017 09:00:00 +0800</pubDate>
        <link>http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E8%AE%A1%E5%88%92/2017/09/27/cross-disciplinary-reading.html</link>
        <guid isPermaLink="true">http://papa.melonfamily.com/%E8%AF%BB%E4%B9%A6%E8%AE%A1%E5%88%92/2017/09/27/cross-disciplinary-reading.html</guid>
        
        <category>misc</category>
        
        
        <category>读书计划</category>
        
      </item>
    
  </channel>
</rss>
